---
- name: Get Server Information
  hosts: localhost
  gather_facts: true
  vars:
    vault_mono_server_ansible_inventory_name: vault_mono_server_ansible_inventory
  vars_files:
    - "{{ playbook_dir }}/vars/main.yml"
    - "{{ playbook_dir }}/vars/vault_install.yml"
  tasks:
    - name: Vault Monorepo | Get Server Information | Check for tools
      run_once: true
      ansible.builtin.shell: "command -v {{ item }} >/dev/null 2>&1"
      changed_when: false
      with_items:
        - terraform
        - bw
        - jq
        - gpg
      tags:
        - always

    - name: Vault Monorepo | Get Server Information | Create mandatory directories
      run_once: true
      ansible.builtin.file:
        state: directory
        path: "{{ item }}"
        mode: "0750"
      with_items:
        - "{{ vault_mono_local_files_dir }}"
        - "{{ vault_mono_prerequisite_files_dir }}"
        - "{{ vault_mono_mutual_tls_files_dir }}"
      tags:
        - always

    - name: Vault Monorepo | Get Server Information | Get Prerequisite Files
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/011-get_prerequisite.yml"
      tags:
        - always

    - name: Vault Monorepo | Get Server Information | Get global configuration
      run_once: true
      ansible.builtin.set_fact:
        vault_mono_global_config: "{{ lookup('ansible.builtin.file', vault_mono_local_file_global_config) | from_json }}"
      tags:
        - patch_server
        - install_vault
        - vault_tls

    - name: Vault Monorepo | Get Server Information | Create Server
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/100-create_server.yml"
      tags:
        - patch_server
        - install_vault
        - vault_tls

- name: Setup Vault Server
  hosts: vault_mono_server_ansible_inventory
  gather_facts: true
  become: true
  vars_files:
    - "{{ playbook_dir }}/vars/main.yml"
    - "{{ playbook_dir }}/vars/vault_install.yml"
    - "{{ playbook_dir }}/vars/minio_install.yml"
  tasks:
    - name: Vault Monorepo | Setup Vault Server | Get global configuration
      ansible.builtin.set_fact:
        vault_mono_global_config: "{{ lookup('ansible.builtin.file', vault_mono_local_file_global_config) | from_json }}"
      tags:
        - always

    - name: Vault Monorepo | Setup Vault Server | Patch System
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/200-patch_system.yml"
      tags:
        - patch_server

    - name: Vault Monorepo | Minio
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/250-minio.yml"
      tags:
        - patch_server
        - install_vault
        - vault_tls

    - name: Vault Monorepo | Setup Vault Server | Install Hashicorp Vault
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/300-install_vault.yml"
      tags:
        - install_vault

    - name: Vault Monorepo | Setup Vault Server | Server TLS Certificate
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/400-vault_tls.yml"
      tags:
        - vault_tls

  handlers:
    - name: Vault Monorepo | Setup Vault Server | Handlers | Restart Vault
      ansible.builtin.service:
        name: "{{ vault_mono_systemd_service_name }}"
        state: "{{ item }}"
      with_items:
        - reloaded
        - restarted

- name: Configure Vault
  hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - "{{ playbook_dir }}/vars/main.yml"
  tasks:
    - name: Vault Monorepo | Configure Vault | Get global configuration
      ansible.builtin.set_fact:
        vault_mono_global_config: "{{ lookup('ansible.builtin.file', vault_mono_local_file_global_config) | from_json }}"
      tags:
        - always

    - name: Vault Monorepo | Configure Vault | Setup Client Certificate
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/500-client_cert.yml"
      tags:
        - vault_init_unseal
        - codified_vault

    - name: Vault Monorepo | Configure Vault | Get Vault Initial Secret
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/550-get_vault_init_secret.yml"
      tags:
        - vault_init_unseal
        - codified_vault

    - name: Vault Monorepo | Configure Vault | Initialize and Unseal
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/600-vault_init_unseal.yml"
      tags:
        - vault_init_unseal

    - name: Vault Monorepo | Configure Vault | Update Vault initial secret
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/650-update_vault_init_secret.yml"
      tags:
        - vault_init_unseal

    - name: Vault Monorepo | Configure Vault | Terraform Codified Vault
      ansible.builtin.import_tasks: "{{ playbook_dir }}/tasks/700-codified_vault_gitlab.yml"
      tags:
        - codified_vault
