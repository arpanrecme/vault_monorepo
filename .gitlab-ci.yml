---
variables:
  GIT_STRATEGY: none
image: arpanrec/vaultmonorepo:4
stages:
  - test
  - vault-action
sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml

terraform_apply:
  stage: vault-action
  rules:
    - changes:
        - terraform/**/*
        - ansible/**/*
        - files/**/*
        - .gitlab-ci.yml
        - inventory.yml
        - requirements.txt
        - ansible.cfg
        - Dockerfile
  before_script:
    - cd /home/vault-mono/repo
    - bw login --apikey --quiet
    - export BW_SESSION=$(bw unlock "${BW_MASTERPASSWORD}" --raw)
    - chmod 750 -R "${PWD}"
  script:
    - ansible-playbook ansible/site.yml
  after_script:
    - bw logout
    - bw status
